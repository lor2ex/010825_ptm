# Post Mortem: Диагностика и восстановление сервера MediaWiki

**Дата инцидента:** 11 ноября 2025  
**Время сессии:** ~2 часа  
**Статус:** Диагностика завершена, решение найдено, проблема решена.  

---

## Резюме инцидента

В ходе инцидента сервер MediaWiki перестал корректно работать из-за ошибки пустого конфигурационного файла LocalSettings.php, который не удалось заменить из-за полного заполнения корневого раздела. После диагностики было обнаружено, что диск заполнен логом Apache access_log-20251110 размером около 7 ГБ. После удаления крупных файлов и очистки места выявили, что некорректно настроенный планировщик задач (cron) постоянно создавал резервные копии, из-за чего диск снова заполнялся. Планировщик был исправлен, настроен автоматический скрипт резервного копирования, права доступа расширены с помощью sudo и root, что позволило восстановить работу сервера и обеспечить стабильность. В дальнейшем рекомендуется настроить ротацию логов, мониторинг дискового пространства и контроль задач cron для предотвращения повторений.


### 1 Начало диагностики

Веб-сервер MediaWiki перестал отвечать на HTTP-запросы с ошибкой **"$wgServer must be set in LocalSettings.php."**. 
- Получен доступ к серверу как обычный пользователь.
- Для выполнения административных действий требовался просто разовый запуск команд с использованием sudo.

### 2. Выявление проблемы

- Обнаружено, что файл LocalSettings.php оказался пустым — критическая ошибка для старта MediaWiki.
- Была попытка восстановить файл: системный администратор предоставил копию с валидными настройками, однако заменить/переписать файл не удалось из-за отсутствия свободного места в файловой системе.

### 3. Диагностика дискового пространства и устранение откровенной причины

- Определено, что на корневом разделе полностью закончилось место.
- С помощью соответствующих команд проведён поиск и удаление крупнейших файлов (предварительно согласовано с администратором).
- После удаления этих файлов появилось достаточное количество свободного места.

### 4. Поиск глубинной причины

- Несмотря на освобождение пространства, проблема повторилась.
- Выяснено, что некорректно настроенный планировщик задач (cron) создавал файлы-архивы каждую минуту, вновь и вновь занимая всё доступное место.

### 5. Исправление корневой причины и финальные действия

- Конфигурация планировщика была обновлена: удалены или изменены проблемные задания.
- Реализован новый скрипт для корректного автоматического резервного копирования (backup).
- Проверена работа cron и других компонентов; ошибка больше не возникала.
- Сайт и все сервисы восстановлены, свободное место поддерживается, резервирование работает корректно.

### 6. Работа с рутом и безопасностью

- В ряде случаев для ключевых операций системный администратор дал временный/разовый доступ к root либо разрешил выполнять определённые команды с sudo.
- Такой подход используется только при невозможности выполнить задачу обычными средствами.

***

**Результат:** Сайт восстановлен, свободное место обеспечено, автоматизация резервного копирования настроена корректно. 

Теперь сценарий и все действия соответствуют реальному подходу инцидент-менеджмента, сосредоточены на сути, лишние детали и неудачные ходы исключены.

---

## 1. Описание инцидента

### 1.1 Первичный симптом

При открытии IP-адреса: 3.74.227.15 веб-сервера в браузере выводилась ошибка:

```
$wgServer must be set in LocalSettings.php. See https://www.mediawiki.org/wiki/Manual:$wgServer
```

Это критическая ошибка загрузки MediaWiki, которая означает, что веб-приложение не может найти свой конфигурационный файл.

---

## 2. Хронология действий и команд

### Этап 1: SSH-подключение к серверу (2 попытки)

**Попытка 1 (неудачная):**
```bash
ssh ec2-user@<IP-адрес>
```

**Результат:**
```
Permission denied (publickey).
```

**Проблема:** SSH демон не находил приватный ключ в стандартном местоположении или ключ имел неправильные права доступа.

---

**Попытка 2 (успешная):**

Нужно явно указать путь к приватному ключу. Все ключи хранятся в домашней директории пользователя в скрытой папке `.ssh/`:

```bash
ls -la ~/.ssh/
```

**Вывод показывал несколько ключей:**
- id_rsa (старый, не используется)
- id_ed25519
- ich.pem ← **нужный ключ для подключения**

**Правильная команда подключения:**
```bash
ssh -i .ssh/ich.pem ec2-user@<IP-адрес>
```

**Результат:** ✅ Успешное подключение к серверу

**Вывод информации:**
- Системный пользователь: `ec2-user`
- **Внутренний IP в VPC:** 172.31.x.x (виртуальный адрес Amazon)
- **Внешний IP:** Тот, на который мы подключались (для публичного доступа)

**Объяснение VPC IP-адресов:** 
В Amazon используется виртуальная приватная сеть (VPC), поэтому с сервера видна внутренняя IP-адресация (172.31.x.x), а подключение идет через внешний адрес.

---

### Этап 2: Поиск файла LocalSettings.php

После подключения обсуждается, с чего начать диагностику. Преподаватель предлагает вариант:

> "Нужно начать с проверки оперативной памяти и места на диске, чтобы понять, в какую сторону копать"

**Команда 1: Поиск файла LocalSettings.php**
```bash
find / -name "LocalSettings.php" 2>/dev/null
```

**Результат:**
```
/var/www/html/mediawiki/LocalSettings.php
```

**Команда 2: Поиск другого файла LocalSettings.php**
```bash
find / -type f -name "*Local*" 2>/dev/null
```

**Нашли нужный:**
```
/home/ec2-user/LocalSettings (5).php

```

**Перезапустили Apache:**
```
sudo service httpd start

```

**Интерпретация:** 
- Файл оказался пустым, 0 байт
- Второй найденый оказался верным и размером 53 кб, админ так же подтвердил
- Скопировали и переименовали файл

**Результат:**
- Sorry! This site is experiencing technical difficulties.

Try waiting a few minutes and reloading.

(Cannot access the database) 

**В файле LocalSettings.php поменяли значение $wgServer на нужный IP адрес**


---

### Этап 3: Поиск больших файлов

После обнаружения полного заполнения диска логично искать, какие файлы занимают больше всего места.

**Команда 2: Поиск файлов размером более 100 MB**
```bash
sudo find / -type f -size +100M -exec du -h {} + 2>/dev/null
```

**Опции команды:**
- `sudo` — с правами администратора
- `find /` — искать по всей файловой системе
- `-type f` — только файлы (не директории)
- `-size +100M` — размером больше 100 мегабайт
- `-exec du -h {} + 2>/dev/null` — вывести информацию о каждом найденном файле

**Результат:**
Команда выполнялась долго и вывела большой список файлов. Но главная находка:

```
/var/log/httpd/access_log-20251110  7.0G  ...
```

**Открытие:** Найден логовый файл веб-сервера Apache размером 7 GB, что занимает почти весь диск.

---

### Этап 4: Анализ найденного файла

**Команда 3: Определение типа файла**
```bash
file /var/log/httpd/access_log-20251110
```

**Результат:**
```
data
```

**Вывод:** Это обычный текстовый файл (логи записываются в текстовом формате).


**Заключение:** Файл содержит обычные логи веб-трафика, которые постоянно растут.

---

### Этап 5: Очистка файла логов

После определения проблемы (огромный лог) логично попробовать его очистить. Но возникают проблемы с правами доступа. Поэтому системный администратор дал временный доступ к root и разрешил нам его очистить.

---

**Простое перенаправление в файл с перезаписью**
```bash
echo "" > /var/log/httpd/access_log-20251110
```

---

---

### Этап 6: Создание скрипта автоматизации

---

**Скрипт авто бэкапа логов**
```bash
#!/bin/bash
LOG_DIR="/var/log"
LOG_FILE="access_log"
BACKUP_DIR="/tmp/"
MAX_BACKUPS=3
DATE=$(date +%Y%m%d)
ARCHIVE="$BACKUP_DIR/$LOG_FILE-$DATE.tar.gz"
tar -czf "$ARCHIVE" "$LOG_DIR/$LOG_FILE"
find "$BACKUP_DIR" -type f -name "$LOG_FILE-*.tar.gz" -mtime +3 -exec rm {} \;
```
**Добавление его в cron**
```bash
0 0 * * * /home/ec2-user/scrips/backup.sh
# * * * * * tar -czf /var/log/httpd/log_$(date +\%Y\%m\%d).tar.gz -C /var/log/httpd .
```

---

## 3. Анализ первопричин (Root Cause Analysis)

### Основная причина

**Отсутствие ротации логов Apache.**

Логовый файл `access_log-20251110` не переименовывался и не архивировался автоматически, поэтому накапливал записи годами, достигнув 7 GB.

### Вторичные причины

1. **Отсутствие мониторинга дискового пространства**
   - Никакая система мониторинга не уведомила администратора о заполнении диска

2. **Отсутствие алертов**
   - Нет автоматических уведомлений при достижении 80%, 90%, 100% использования диска

3. **Высокий уровень логирования**
   - Возможно, Apache настроен на чрезмерное логирование всех запросов

4. **Отсутствие техдокументации**
   - Нет инструкции для дежурного инженера по "что делать при переполнении диска"

---



## 7. Рекомендации для профилактики

### Немедленные действия

1. Очистить логовый файл одним из предложенных способов
2. Перезагрузить Apache (если требуется)
3. Проверить доступность MediaWiki

### Долгосрочные действия

1. **Настроить `logrotate`** для автоматической ротации логов
2. **Включить мониторинг** дискового пространства
3. **Настроить алерты** при 80%, 90% заполнения
4. **Проверить cron-задачи** на чрезмерное логирование
5. **Снизить LogLevel** в Apache (если требуется)
6. **Создать документацию** по обслуживанию

---

## Заключение

Инцидент продемонстрировал классический сценарий сбоя сервера из-за переполнения дискового пространства. Несмотря на сложности с правами доступа, диагностика была выполнена правильно и методично.

**Ключевые выводы:**
- Проверка `df -h` должна быть **первым шагом** при любой диагностике сервера
- Поиск больших файлов через `find` помогает быстро локализовать проблему
- Недостаток прав доступа требует координации с администратором
- **Профилактика лучше лечения** — нужна автоматическая ротация логов и мониторинг

---

